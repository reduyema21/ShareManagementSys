@using Microsoft.AspNetCore.Identity
@using SaccoShareManagementSys.Data
@using SaccoShareManagementSys.Models
@using Microsoft.EntityFrameworkCore

@{
    var path = Context.Request.Path.Value?.ToLower() ?? string.Empty;

    bool showSidebar = !(path.Contains("/account/login") ||
                         path.Contains("/account/register") ||
                         path.Contains("/account/logout"));

    Func<string, string> isActive = controller =>
        path.Contains($"/{controller.ToLower()}") ? "active" : "";
}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SACCO Share Management System</title>

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback" />
    <link rel="stylesheet" href="@Url.Content("~/AdminLTE/plugins/fontawesome-free/css/all.min.css")" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- AdminLTE -->
    <link rel="stylesheet" href="@Url.Content("~/AdminLTE/dist/css/adminlte.min.css")" />
    <link rel="stylesheet" href="@Url.Content("~/AdminLTE/plugins/overlayScrollbars/css/OverlayScrollbars.min.css")" />
</head>

<body class="hold-transition sidebar-mini layout-fixed">

    <div class="wrapper">

        <!-- NAVBAR -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">

            <!-- Sidebar Toggle Button -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" id="toggleSidebarBtn" role="button">
                        <i class="fas fa-bars"></i>
                    </a>
                </li>
            </ul>

            <!-- RIGHT SIDE USER INFO -->
            <ul class="navbar-nav ml-auto">
                @if (User.Identity != null && User.Identity.IsAuthenticated)
                {
                    <li class="nav-item">
                        <span class="nav-link">
                            <i class="fas fa-user-circle"></i>
                            Welcome, <strong>@User.Identity.Name</strong>
                        </span>
                    </li>
                    <li class="nav-item">
                        <form asp-area="Identity" asp-page="/Account/Logout" method="post">
                            <button type="submit" class="btn btn-danger btn-sm">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </form>
                    </li>
                }
                else
                {
                    <li class="nav-item">
                        <a asp-area="Identity" asp-page="/Account/Login" class="nav-link">Login</a>
                    </li>
                    <li class="nav-item">
                        <a asp-area="Identity" asp-page="/Account/Register" class="nav-link">Register</a>
                    </li>
                }

            </ul>
        </nav>

        @if (showSidebar)
        {
            <!-- SIDEBAR -->
            <aside class="main-sidebar sidebar-dark-primary elevation-4">

                <!-- Brand Logo -->
                <a asp-controller="@(User.IsInRole("Admin") ? "Home" : "Member")"
                   asp-action="Index"
                   class="brand-link">

                    <img src="@Url.Content("~/AdminLTE/dist/img/AdminLTELogo.png")"
                         class="brand-image img-circle elevation-3" style="opacity:.8">
                    <span class="brand-text font-weight-light">SACCO System</span>
                </a>

                <!-- Sidebar content -->
                <div class="sidebar">

                    <!-- User Panel -->
                    <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                        @{
                            var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

                            // Get ApplicationDbContext from DI (non-generic version)
                            var db = Context.RequestServices.GetService(typeof(ApplicationDbContext)) as ApplicationDbContext;

                            // Get profile image for current user
                            var img = db?.ProfileImg?.FirstOrDefault(p => p.UserId == userId);

                            var profileImgUrl = img != null
                            ? Url.Action("ShowImage", "ProfileImg", new { id = img.Id, v = DateTime.Now.Ticks })
                            : Url.Content("~/AdminLTE/dist/img/user2-160x160.jpg");
                        }

                        <div class="image">
                            <img src="@profileImgUrl" class="img-circle elevation-2" alt="User Image">
                        </div>


                        <div class="info">
                            <a href="#" class="d-block">
                                @if (User.Identity != null && User.Identity.IsAuthenticated)
                                {
                                    @User.Identity.Name

                                    @if (User.IsInRole("Admin"))
                                    {
                                        <span>(Admin)</span>
                                    }
                                    else if (User.IsInRole("Member"))
                                    {
                                        <span>(Member)</span>
                                    }
                                    <!-- DEBUG: show UserId -->
                                    <p style="color:white;font-size:10px">
                                        UserId: @User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
                                    </p>
                                }
                                else
                                {
                                    <span>Guest User</span>  //guest user means not logged in or unauthorized user
                                }
                            </a>
                        </div>

                    </div>

                    <!-- Sidebar Menu -->
                    <nav class="mt-2">
                        <ul class="nav nav-pills nav-sidebar flex-column" role="menu">

                            @* ================= ADMIN MENU ================= *@
                            @if (User.IsInRole("Admin"))
                            {
                                <li class="nav-item">
                                    <a asp-controller="Home" asp-action="Index" class="nav-link @isActive("Home")">
                                        <i class="nav-icon fas fa-tachometer-alt"></i>
                                        <p>Admin Dashboard</p>
                                    </a>
                                </li>

                                <li class="nav-item">
                                    <a asp-controller="Shareholders" asp-action="Index" class="nav-link @isActive("Shareholders")">
                                        <i class="nav-icon fas fa-users"></i>
                                        <p>Shareholders</p>
                                    </a>
                                </li>

                                <li class="nav-item">
                                    <a asp-controller="Shares" asp-action="Index" class="nav-link @isActive("Shares")">
                                        <i class="nav-icon fas fa-coins"></i>
                                        <p>Shares</p>
                                    </a>
                                </li>

                                <li class="nav-item">
                                    <a asp-controller="Transactions" asp-action="Index" class="nav-link @isActive("Transactions")">
                                        <i class="nav-icon fas fa-exchange-alt"></i>
                                        <p>Transactions</p>
                                    </a>
                                </li>

                                <li class="nav-item">
                                    <a asp-controller="Dividends" asp-action="Index" class="nav-link @isActive("Dividends")">
                                        <i class="nav-icon fas fa-hand-holding-usd"></i>
                                        <p>Dividends</p>
                                    </a>
                                </li>

                                <li class="nav-item">
                                    <a asp-controller="ShareTransfers" asp-action="Index" class="nav-link @isActive("ShareTransfers")">
                                        <i class="nav-icon fas fa-random"></i>
                                        <p>Share Transfers</p>
                                    </a>
                                </li>

                                @* <li class="nav-item">
                                    <a asp-controller="UserRoles" asp-action="Assign" class="btn btn-sm btn-primary m-3">
                                        <i class="fas fa-user-tag"></i> Assign Role
                                    </a>
                                </li> *@
                                @if (User.IsInRole("Admin") || User.IsInRole("Member"))
                                {
                                    <li class="nav-item mt-2">
                                        <a asp-controller="ProfileImg" asp-action="Upload" class="btn btn-sm btn-primary w-100">
                                            <i class="fas fa-image"></i> Upload Profile Image
                                        </a>
                                    </li>

                                    <li class="nav-item mt-1">
                                        <a asp-controller="ProfileImg" asp-action="ViewImage" class="btn btn-sm btn-info w-100">
                                            <i class="fas fa-eye"></i> View My Profile Image
                                        </a>
                                    </li>
                                }


                            }

                            @* ================= MEMBER MENU ================= *@
                            @if (User.IsInRole("Member"))
                            {
                                <li class="nav-item">
                                    <a asp-controller="Member" asp-action="Index" class="nav-link @isActive("Member")">
                                        <i class="nav-icon fas fa-user"></i>
                                        <p>My Dashboard</p>
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            </aside>
        }

        <!-- MAIN CONTENT -->
        <div class="content-wrapper">
            <section class="content">
                <div class="container-fluid">
                    @RenderBody()
                </div>
            </section>
        </div>

        <!-- FOOTER -->
        <footer class="main-footer">
            <strong>Copyright &copy; 2025.</strong>
            All rights reserved.
        </footer>

    </div>

    <!-- SCRIPTS -->
    <script src="@Url.Content("~/AdminLTE/plugins/jquery/jquery.min.js")"></script>
    <script src="@Url.Content("~/AdminLTE/plugins/bootstrap/js/bootstrap.bundle.min.js")"></script>
    <script src="@Url.Content("~/AdminLTE/dist/js/adminlte.js")"></script>

    <!-- SIDEBAR TOGGLE SCRIPT -->
    <script>
        document.getElementById("toggleSidebarBtn").addEventListener("click", function () {
            document.body.classList.toggle("sidebar-collapse");
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>



